---
- name: Actividad 3 - Seguridad y Auditoría TechCorp
  hosts: all
  become: yes  # Activado globalmente porque ya configuraste sudoers

  tasks:
    # 1. Auditoría de tiempo de actividad
    - name: Ejecutar comando uptime
      command: uptime
      register: uptime_result
      changed_when: false

    # 2. Gestión de usuarios masiva (Loop)
    - name: Crear usuarios del equipo de auditoría
      user:
        name: "{{ item }}"
        groups: sudo
        append: yes
        state: present
      loop: "{{ audit_team }}"

    # 3. Seguridad SSH (Condicional y Registro)
    - name: Verificar existencia de sshd_config
      stat:
        path: /etc/ssh/sshd_config
      register: ssh_config

    - name: Deshabilitar login de root en SSH
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
      when: ssh_config.stat.exists
      notify: Reiniciar SSH

    # 4. Lógica de Grupos (Solo Producción)
    - name: Instalar fail2ban en servidores de produccion
      apt:
        name: fail2ban
        state: present
        update_cache: yes
      when: "'prod' in group_names"

    # 5. Lógica de Grupos (Solo DB - Asegurar limpieza)
    - name: Asegurar que nginx este detenido en db_servers
      service:
        name: nginx
        state: stopped
        enabled: no
      when: "'db_servers' in group_names"
      ignore_errors: yes

    # 6. Registro de Log con variable dinámica
    - name: Escribir resultado de uptime en log
      copy:
        content: "{{ uptime_result.stdout }}"
        dest: "{{ log_path }}"
      when: uptime_result.rc == 0

  handlers:
    - name: Reiniciar SSH
      service:
        name: ssh
        state: restarted
